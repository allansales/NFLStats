---
title: "Power Ranking Modelling a"
output: html_notebook
---
  
```{r}
library(caret)
library(tidyverse)
```

# Functions load
```{r}
insert_at_position = function(vector, bye_teams_rank){
  n = nrow(bye_teams_rank)
  elements_to_insert = bye_teams_rank$Team_target
  position_to_insert = bye_teams_rank$rank
  
  for(pos in 1:n){
    vector = vector %>% append(elements_to_insert[pos],(position_to_insert[pos]-1))
  }
  
  return(vector)
}

get_rank_s_w <- function(test_machine_based, week_games, prediction_s_w, week){
  
  all_teams = test_machine_based$Team_target %>% unique()
  bye_teams = setdiff(all_teams, week_games$Team_target)
  bye_teams_rank = test_machine_based %>% filter(Week == (week-1), Team_target %in% bye_teams) %>% select(Team_target, rank)
  
  partial_rank = week_games %>% select(Season, Week, Team_target) %>% bind_cols(partial_rank = (prediction_s_w + week_games$Previous_Rank) %>% rank()) %>% arrange(partial_rank)
  final_rank_position = partial_rank$Team_target
  
  if(length(final_rank_position)!= 32){ #32 total of teams
    final_rank_position = insert_at_position(partial_rank$Team_target, bye_teams_rank)  
  }
  
  final_rank = data_frame(Season = partial_rank$Season %>% unique(), Week = partial_rank$Week %>% unique(), Team_target = final_rank_position, rank = 1:32)
  
  return(final_rank)
}

update_data_frame = function(full_data, replacement_data, update_next_week = T){
  
  season = replacement_data$Season %>% unique()
  week = replacement_data$Week %>% unique()
  
  # update rank_change
  full_data_s_w = full_data %>% filter(Season == season, Week == week) %>% select(-rank, -Rank_change)
  full_data_s_w = full_data_s_w %>% right_join(replacement_data) %>% mutate(Rank_change = rank - Previous_Rank)
  
  full_data = full_data %>% filter(Season == season, Week != week)
  full_data = full_data %>% bind_rows(full_data_s_w)
  
  # update previous_rank of next week
  if(((week+1) <= max(full_data$Week)) & update_next_week){
    full_data_s_next_w = full_data %>% filter(Season == season, Week == (week+1)) %>% select(-Previous_Rank)
    full_data_s_next_w = full_data_s_next_w %>% right_join(replacement_data %>% select(Previous_Rank = rank, -Week, Season, Team_target))
    
    full_data = full_data %>% filter(Season == season, Week != (week+1))
    full_data = full_data %>% bind_rows(full_data_s_next_w)    
  }
  
  full_data = full_data %>% select(Season, Week, Team_target, rank, Previous_Rank, Rank_change)
  return(full_data)
}

get_full_rank = function(test, update_next_week = TRUE){
  test_temp = test
  max_season = max(test_temp$Season)
  min_season = min(test_temp$Season)
  
  max_week = max(test_temp$Week)
  min_week = min(test_temp$Week)
  
  
  for(s in min_season:max_season){
    for(w in min_week:max_week){
      week_games = test_temp %>% filter(Season == s, Week == w)
      prediction_s_w = predict(lmCVFit, week_games)
      new_rank = get_rank_s_w(test_temp, week_games, prediction_s_w, w)
      test_temp = update_data_frame(test_temp, new_rank, update_next_week = F)
    }
  }
  
  #test_temp = test_temp %>% select(Season, Week, Team_target, rank, Previous_Rank, Rank_change)
  return(test_temp)
}
```

# Data load
```{r}
games_context = read_csv("games_context.csv")
```

## Power Ranking load 
```{r}
power_rankings = read_csv("python_crawlers/crawlers/spiders/nfl.csv")
power_rankings = power_rankings %>% select(Team_target = team, Season = year, Week = week, human_rank = rank) %>% filter(Season == 2015, Week %in% 1:17)
power_rankings$Week = power_rankings$Week %>% as.integer()
```

# Train and Test split
```{r}
train = games_context %>% filter(Season <= 2014)
test = games_context %>% filter(Season > 2014)
```

```{r}
test_clean_data = test %>% ungroup() %>% select(-Date, -Team_target, -Team_adversary, -Season, -Week, -Day_of_week, -Type, -record, -record_adversary, -rank, -rank_adversary, -Rank_change_adversary, -n_ties, -n_ties_adversary)

train_clean_data = train %>% ungroup() %>% select(-Date, -Team_target, -Team_adversary, -Season, -Week, -Day_of_week, -Type, -record, -record_adversary, -rank, -rank_adversary, -Rank_change_adversary, -n_ties, -n_ties_adversary)
```

## Multiple regression
```{r}
ctrl = trainControl(method = "cv", number = 10)

lmCVFit = train(Rank_change ~ ., data = train_clean_data, method = "lm", trControl = ctrl, metric="Rsquared")

residuals = resid(lmCVFit)
predictedValues = predict(lmCVFit)
predictedVal = predict(lmCVFit, test_clean_data)
modelvalues = data.frame(obs = test_clean_data$Rank_change, pred=predictedVal)
```

```{r}
plot(train_clean_data$Rank_change, residuals)
plot(varImp(lmCVFit))
defaultSummary(modelvalues)

saveRDS(lmCVFit, "power_ranking_variations.rds")
```

# 2015 Test using human power rankings of last week
## Add bye week
```{r}
team_bye = test %>%
  select(Team_target, Season, Week) %>%
  group_by(Team_target, Season) %>%
  summarise(bye = setdiff(1:17, Week), last_game = bye - 1)

rank_bye = test %>% select(rank, Team_target, Season, Week) %>% inner_join(team_bye, by = c("Team_target" = "Team_target", "Season" = "Season", "Week" = "last_game"))
```

## 2015 Test using humans' power rankings of last week
```{r}
human_based_model = get_full_rank(test, F)
```

## Correlation test between power ranking and model's prediction based on human's rank
```{r}
model_rank = test_human_based %>% select(Season, Week, Team_target, model_rank = rank)
ranks = power_rankings %>% inner_join(model_rank) %>% arrange(Season, Week, model_rank)
corr_1 = ranks %>% group_by(Season, Week) %>% summarise(Correlation = cor.test(human_rank, model_rank, method = "spearman", alternative = "two.sided")$estimate)
```

# 2015 Test using model's power rankings of last week
```{r}
machine_based_model = get_full_rank(test)
```

## Correlation test between power ranking and model's prediction
```{r}
model_rank = test_machine_based %>% select(Season, Week, Team_target, model_rank = rank)
ranks = power_rankings %>% inner_join(model_rank) %>% arrange(Season, Week, model_rank)
corr_2 = ranks %>% group_by(Season, Week) %>% summarise(Correlation = cor.test(human_rank, model_rank, method = "spearman", alternative = "two.sided")$estimate)
```

# Correct games per week
```{r}
test_machine_based = test_machine_based %>% mutate(Game_winner = if_else(Team_target_score > Team_adversary_score, Team_target, 
                                                                         if_else(Team_target_score < Team_adversary_score, Team_adversary, "Draw")))


test_machine_based = test_machine_based %>% mutate(expect = if_else(Previous_Rank > Previous_Rank_adversary, Team_target, 
                                                                    if_else(Previous_Rank < Previous_Rank_adversary, Team_adversary, "Draw")))
```

## Model's winners
```{r}
```

